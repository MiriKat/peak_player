var chartdata = {
  "fontStack": "'Open Sans', sans-serif",
  "dataset": [
    {
      "label": "A",
      "fill": "#FF5722",
      "children": [
        {
          "label": "A",
          "children": [
            {
              "label": "A",
              "count": "4"
            }
          ]
        }
      ]
    },
    {
      "label": "B",
      "fill": "#E91E63",
      "children": [
        {
          "label": "B",
          "children": [
            {
              "label": "B",
              "count": "12"
            },
            {
              "label": "B",
              "count": "22"
            },
            {
              "label": "B",
              "count": "2"
            },
            {
              "label": "B",
              "count": "2"
            },
            {
              "label": "B",
              "count": "2"
            },
            {
              "label": "B",
              "count": "2"
            }
          ]
        },
        {
          "label": "B",
          "children": [
            {
              "label": "B",
              "count": "2"
            },
            {
              "label": "B",
              "count": "9"
            },
            {
              "label": "B",
              "count": "8"
            }
          ]
        }
      ]
    },
    {
      "label": "C",
      "fill": "#9C27B0",
      "children": [
        {
          "label": "C",
          "children": [
            {
              "label": "C",
              "count": "5"
            }
          ]
        },
        {
          "label": "C",
          "children": [
            {
              "label": "C",
              "count": "2"
            },
          ]
        },
        {
          "label": "C",
          "children": [
            {
              "label": "C",
              "count": "2"
            },
          ]
        },
        {
          "label": "C",
          "children": [
            {
              "label": "C",
              "count": "4"
            }
          ]
        }
      ]
    },
    {
      "label": "D",
      "fill": "#673AB7",
      "children": [
        {
          "label": "D",
          "children":[
            {
              "label": "D",
              "count": "2"
            }
          ]
        },
        {
          "label": "D",
          "children": [
            {
              "label": "D",
              "count": "4"
            }
          ]
        }
      ]
    },
    {
      "label": "E",
      "fill": "#3F51B5",
      "children": [
        // start
        {
          "label": "E",
          "children": [
            {
              "label": "E",
              "count": "3"
            }
          ]
        },
        {
          "label": "E",
          "children": [
            {
              "label": "E",
              "count": "3"
            }
          ]
        },
        {
          "label": "E",
          "children": [
            {
              "label": "E",
              "count": "3"
            },
            {
              "label": "E",
              "count": "2"
            }
          ]
        },
        {
          "label": "E",
          "children": [
            {
              "label": "E",
              "count": "3"
            }
          ]
        },
        {
          "label": "E",
          "children": [
            {
              "label": "E",
              "count": "5"
            },
            {
              "label": "E",
              "count": "4"
            }
          ]
        }
      ]
    },
    {
      "label": "F",
      "fill": "#5677FC",
      "children": [
        {
          "label": "F",
          "children": [
            {
              "label": "F",
              "count": "6"
            }
          ]
        }
      ]
    },
    {
      "label": "G",
      "fill": "#03A9F4",
      "children": [
        {
          "label": "G",
          "children": [
            {
              "label": "G",
              "count": "2"
            },
            {
              "label": "G",
              "count": "2"
            }
          ]
        },
        {
          "label": "G",
          "children": [
            {
              "label": "G",
              "count": "6"
            }
          ]
        },
        {
          "label": "G",
          "children": [
            {
              "label": "G",
              "count": "2"
            }
          ]
        },
        {
          "label": "G",
          "children": [
            {
              "label": "G",
              "count": "2"
            }
          ]
        },
        {
          "label": "G",
          "children": [
            {
              "label": "G",
              "count": "3"
            }
          ]
        }
      ]
    },
    {
      "label": "H",
      "fill": "#00BCD4",
      "children": [
        {
          "label": "H",
          "children": [
            {
              "label": "H",
              "count": "2"
            }
          ]
        },
        {
          "label": "H",
          "children": [
            {
              "label": "H",
              "count": "2"
            }
          ]
        }
      ]
    },
    {
      "label": "I",
      "fill": "#009688",
      "children": [
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "2"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "4"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "4"
            },
            {
              "label": "I",
              "count": "2"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "3"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "3"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "3"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "3"
            }
          ]
        },
        {
          "label": "I",
          "children": [
            {
              "label": "I",
              "count": "6"
            }
          ]
        }
      ]
    },
    {
      "label": "J",
      "fill": "#4CAf50",
      "children": [
        {
          "label": "J",
          "children": [
            {
              "label": "J",
              "count": "4"
            }
          ]
        }
      ]
    },
    {
      "label": "K",
      "fill": "#FF9800",
      "children": [
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "4"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "3"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "4"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "3"
            },
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "4"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "5"
            },
            {
              "label": "K",
              "count": "2"
            },
            {
              "label": "K",
              "count": "4"
            },
            {
              "label": "K",
              "count": "3"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "3"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "2"
            }
          ]
        },
        {
          "label": "K",
          "children": [
            {
              "label": "K",
              "count": "5"
            },
            {
              "label": "K",
              "count": "3"
            }
          ]
        }
      ]
    }
  ]
}


window.requestAnimFrame = function(){
return (
  window.requestAnimationFrame       || 
  window.webkitRequestAnimationFrame || 
  window.mozRequestAnimationFrame    || 
  window.oRequestAnimationFrame      || 
  window.msRequestAnimationFrame     || 
  function(/* function */ callback){
    window.setTimeout(callback, 1000 / 60);
  }
);
}();


/* Build the chart and add interactivity*/
var nestedChart = {
  chartData : null,
  totalCount : 0,
  expandedCount : 0,

  arcRadius : [150, 200, 250],
  currentDrawnAngles : Array(0,0,0),

  pRadius: 200,
  cRadius: 250,
  chartCenter : 250,

  rings : Array(),

  currentOPosition : 0,
  currentPPosition : 0,

  currentOAngle : 0,
  currentPAngle : 0,
  currentCAngle : 0,
  tooltipActive : true,
  isExpandedView : false,

  animationStart : null,
  tweenArcDuration : 250,
  expandedData : null,

  polarToCartesian : function (radius, angleInDegrees) {
    var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
    return {
      x: nestedChart.chartCenter + (radius * Math.cos(angleInRadians)),
      y: nestedChart.chartCenter + (radius * Math.sin(angleInRadians))
    };
  },

  describeArc : function(radius, startAngle, endAngle){
    var start = this.polarToCartesian(radius, endAngle);
    var end = this.polarToCartesian(radius, startAngle);
    var arcSweep = endAngle - startAngle <= 180 ? "0" : "1";
    var d = [
      "M", start.x, start.y, 
      "A", radius, radius, 0, arcSweep, 0, end.x, end.y,
      "L", nestedChart.chartCenter,nestedChart.chartCenter,
      "L", start.x, start.y
    ].join(" ");
    return d; 
  },

  createCircleMask: function(id, parent, radius){
    NS = "http://www.w3.org/2000/svg";
    maskBg = document.createElementNS(NS, 'rect');
    maskBg.setAttribute('width', '100%');
    maskBg.setAttribute('height', '100%');
    maskBg.setAttribute('x', '0');
    maskBg.setAttribute('y', '0');
    maskBg.setAttribute('fill', 'white');

    cMask = document.createElementNS(NS, "mask");  
    cMask.setAttribute("id", id);   
    cMask.appendChild(maskBg);  

    cMaskCircle = document.createElementNS(NS, 'circle');
    cMaskCircle.setAttribute("r", radius);
    cMaskCircle.setAttribute("cx", nestedChart.chartCenter);
    cMaskCircle.setAttribute("cy", nestedChart.chartCenter);
    cMaskCircle.setAttribute("fill", 'black');

    cMask.appendChild(cMaskCircle);
    parent.appendChild(cMask);
  },

  displayTooltip: function(count, label, group){
    this.tooltipActive = true;
    nestedChart.tooltip.style.opacity = 1;
    nestedChart.tooltip.innerHTML = '<strong>'+label+': </strong> '+count;

  },
  
  hideTooltip: function(){
    this.tooltipActive = false;
    nestedChart.tooltip.style.opacity = 0;
  },

  handleMouseMove : function(event){

    e = event || window.event;     
    var dot, eventDoc, doc, body, pageX, pageY;
    mouseX = (window.Event) ? e.pageX : event.clientX + (document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft);
    mouseY = (window.Event) ? e.pageY : event.clientY + (document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop);
    nestedChart.tooltip.style.left = mouseX+'px';
    nestedChart.tooltip.style.top = (mouseY - 30)+'px';
  },

  createArc: function(stat){
    startAngle = this.currentDrawnAngles[stat.level];
    angleIncrease = (stat.count / nestedChart.totalCount) * 360;
    endAngle = angleIncrease + startAngle;
    path = document.createElementNS(NS, "path");
    path.setAttribute('fill', stat.fill);
    path.setAttribute("d", nestedChart.describeArc(this.arcRadius[stat.level], startAngle, endAngle ));

    stat.arc = path;
    stat.radius = this.arcRadius[stat.level];
    stat.startAngle = startAngle;
    stat.endAngle = endAngle;
    stat.currentAngleSize = endAngle - startAngle;
    stat.originalAngleSize = stat.currentAngleSize 
    if(this.rings[stat.level] == null){
      this.rings[stat.level] = new Array();
    }
    this.rings[stat.level].push(stat);

    if (Modernizr.touchevents) {
      mc = new Hammer.Manager(path);
      mc.add( new Hammer.Tap({ event: 'doubletap', taps: 2 }) );
      mc.add( new Hammer.Tap({ event: 'singletap' }) );

      mc.on('singletap', function(ev) {
        nestedChart.handleMouseMove();
        nestedChart.displayTooltip(stat.count, stat.label);
      });
      mc.on('doubletap', function(ev) {
        nestedChart.expandArc(stat);
      });

    }else{ 
      path.onmouseover = function(e) {
        nestedChart.displayTooltip(stat.count, stat.label);
      }
      path.onmouseleave = function(e) {
        nestedChart.hideTooltip();
      }
      if(stat.level < 2){
        path.onclick = function(e) {
          nestedChart.expandArc(stat);
        }
      }

    }         

    parent = document.getElementById('arc-group-'+stat.level);
    parent.appendChild(path);
    this.currentDrawnAngles[stat.level] = endAngle;
  },


  isExpandedMatch : function(dataset){
    isMatch = true;
    if(dataset.level >= nestedChart.expandedData.level){
      max = nestedChart.expandedData.level;
    }else{
      max = dataset.level;
    }
    for(i=0; i<max+1; i++){
      if(dataset.parents[i] != nestedChart.expandedData.parents[i]){
        isMatch = false;
      }
    }
    return isMatch;

  },


  tweenArc : function(timestamp){
    if (!this.animationStart) this.animationStart = timestamp;
    var progress = timestamp - this.animationStart;
    progress = progress / nestedChart.tweenArcDuration;


    var i,j,currentAngle;
    for(i=0; i<nestedChart.totalDepth+1; i++){
      ring = nestedChart.rings[i];
      startAngle = 0;
      for(j=0; j<ring.length; j++){
        dataset = ring[j];
        // start of dataset
        currentAngleSize = dataset.originalAngleSize + (dataset.targetAngleSize - dataset.originalAngleSize )*progress;
        if(dataset.targetAngleSize > dataset.originalAngleSize){
          if(currentAngleSize < dataset.targetAngleSize){
            angleGrowth = currentAngleSize;
          }else{
            angleGrowth = dataset.targetAngleSize;
            dataset.originalAngleSize = dataset.targetAngleSize;
          }
        }else{
          if(dataset.targetAngleSize < currentAngleSize){
            angleGrowth = currentAngleSize;
          }else{
            angleGrowth = dataset.targetAngleSize;
            dataset.originalAngleSize = dataset.targetAngleSize;
          }
        }
        dataset.arc.setAttribute("d", nestedChart.describeArc(nestedChart.arcRadius[dataset.level], startAngle, startAngle+angleGrowth));
        startAngle = startAngle+angleGrowth;
      }
    }
   
    if (progress < 1) {
      window.requestAnimFrame(nestedChart.tweenArc);
    }else{
      this.animationStart = null;
    }
  },

  expandArc : function(e){
    if(this.isExpandedView && (e.level == this.expandedData.level)){
      // toggle back to default view
      this.isExpandedView = false;
      this.expandedData = {
        'total' : nestedChart.totalCount,
        'level' : 0,
        'parents' : null
      };
    }else{
      // show expanded view
      this.isExpandedView = true;
      this.expandedData = {
        'total' : e.count,
        'level' : e.level,
        'parents' : e.parents
      };
    }

    var i,j;
    for(i=0; i<nestedChart.totalDepth+1; i++){
      ring = nestedChart.rings[i];
      for(j=0; j<ring.length; j++){
        dataset = ring[j];
        if(this.isExpandedView){
          dataset.isExpandedMatch = this.isExpandedMatch(dataset);
        }else{
          dataset.isExpandedMatch = 1;
        }
        if(dataset.isExpandedMatch){
          targetAngleSize = dataset.count / this.expandedData.total * 360;
          if(targetAngleSize > 359.99){
            targetAngleSize = 359.99;
          }
          dataset.targetAngleSize = targetAngleSize;
          if(i==0 && j == 0){
            console.log(targetAngleSize);
          }
        }else{
          dataset.targetAngleSize = 0;
        }
      }
    }
    window.requestAnimFrame(nestedChart.tweenArc);
  },

  initialize : function(containerID, chartData){

    var container = document.getElementById(containerID);
    var NS = "http://www.w3.org/2000/svg";
    var svg = document.createElementNS(NS, "svg");
    svg.setAttribute('viewBox', '0 0 500 500');
    svg.setAttribute('style', 'width:100%; height:auto');

    styleTag = document.createElementNS(NS, "style");
    styleTag.textContent =  "path{ stroke:rgba(0,0,0,1); stroke-width:0.5px; stroke-opacity:1; fill-opacity:0.5; transition:stroke-opacity 0.0625s;  transition:stroke-opacity 0.25s;}"; 
    styleTag.textContent += "path:hover{ fill-opacity:1; }"; 


    svg.appendChild(styleTag);

    defs = document.createElementNS(NS, "defs");
    svg.appendChild(defs);

    arcGroup = document.createElementNS(NS, "g");

    this.createCircleMask('p-mask', defs, nestedChart.arcRadius[0]);
    this.createCircleMask('c-mask', defs, nestedChart.arcRadius[1]);
    
    styleTag.textContent += "#grow-clip-path-circle{transform-origin: 250px 250px;animation: fillup 0.5s 1;}";
    styleTag.textContent += "#arc-group{transform-origin: 250px 250px;animation: fillup 0.5s 1;}";
    styleTag.textContent += "@keyframes fillup {from { transform: scale(0); } to {transform: scale(1);}}"; 

    growClipPath = document.createElementNS(NS, "clipPath");  
    growClipPath.setAttribute("id", 'grow-clip-path');   

    growClipPathCircle = document.createElementNS(NS, 'circle');
    growClipPathCircle.setAttribute("r", this.arcRadius[2]);
    growClipPathCircle.setAttribute("cx", this.chartCenter);
    growClipPathCircle.setAttribute("cy", this.chartCenter);
    growClipPathCircle.setAttribute("id", 'grow-clip-path-circle');
    growClipPath.appendChild(growClipPathCircle);
    defs.appendChild(growClipPath);

    arcGroup.setAttribute('clip-path', 'url(#grow-clip-path)');
    arcGroup.setAttribute('id', 'arc-group');


    cGroup = document.createElementNS(NS, "g");
    cGroup.setAttribute('id', 'arc-group-2');
    cGroup.setAttribute('mask', 'url(#c-mask)');
    arcGroup.appendChild(cGroup);

    pGroup = document.createElementNS(NS, "g");
    pGroup.setAttribute('id', 'arc-group-1');
    pGroup.setAttribute('mask', 'url(#p-mask)');
    arcGroup.appendChild(pGroup);

    oGroup = document.createElementNS(NS, "g");
    oGroup.setAttribute('id', 'arc-group-0');
    arcGroup.appendChild(oGroup);


    svg.appendChild(arcGroup);

    this.tooltip = document.createElement("span");
    this.tooltip.setAttribute('style', 'font-family:'+chartData.fontStack+';padding:5px;font-size:12px;display:block;background-color:#fff;transition:opacity 1s, left 0s, top 0s; border:1px solid #ccc; border-radius:3px; position:absolute;pointer-events:none;opacity:0;');

    document.body.appendChild(this.tooltip);
    document.onmousemove = this.handleMouseMove;

    container.appendChild(svg);

    parents = new Array();
    parentsPosition = new Array();
    chartData.dataset.forEach(function(o) {
      if (parentsPosition[0] == null) {
        parentsPosition[0] = -1;
      }
      parentsPosition[0]++;
      o.parents = Array();
      o.parents[0] = parentsPosition[0];


      oCount = 0;
      o.level = 0;

      o.children.forEach(function(p) {
        if (parentsPosition[1] == null) {
           parentsPosition[1] = -1;
        }
        parentsPosition[1]++;
        p.parents = new Array();
        p.parents[0] = parentsPosition[0]; 
        p.parents[1] = parentsPosition[1];


        if(!p.fill){
          p.fill = o.fill;
        }

        pCount = 0;
        p.level = 1;

        p.children.forEach(function(c) {
          if (parentsPosition[2] == null) {
             parentsPosition[2] = -1;
          }
          parentsPosition[2]++;
          c.parents = new Array();
          c.parents[0] = parentsPosition[0]; 
          c.parents[1] = parentsPosition[1];
          c.parents[2] = parentsPosition[2];
          if(!c.fill){
            c.fill = p.fill;
          }
          c.level = 2;
          nestedChart.totalCount += parseInt(c.count, 10);
          pCount += parseInt(c.count, 10);
          oCount += parseInt(c.count, 10);
        });
        p.count = pCount;
      });
      o.count = oCount;
    });
    this.chartData = chartData;

    chartData.dataset.forEach(function(o) {
      nestedChart.createArc(o);
      o.children.forEach(function(p) {
        nestedChart.createArc(p);
        p.children.forEach(function(c) {
          nestedChart.createArc(c);
        });
      });
    });
    nestedChart.totalDepth = 2;
  }
}

nestedChart.initialize('chart-container', chartdata);
